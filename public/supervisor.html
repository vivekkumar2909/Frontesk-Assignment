<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Supervisor Panel</title>
    <style>
        body {
            font-family: Arial;
            margin: 20px
        }

        .card {
            border: 1px solid #ddd;
            padding: 12px;
            margin: 12px 0;
            border-radius: 6px
        }

        textarea {
            width: 100%;
            height: 80px
        }
    </style>
</head>

<body>
    <h2>Supervisor Panel</h2>
    <div>
        <button id="refresh">Refresh</button>
        <button id="showAll">Show All Requests</button>
    </div>
    <h3>Pending Requests</h3>
    <div id="list"></div>

    <h3>Knowledge Base (Learned Answers)</h3>
    <div id="kb"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        async function fetchPending() { fetch('/api/requests/pending').then(r => r.json()).then(render); fetch('/api/kb').then(r => r.json()).then(renderKb); }
        document.getElementById('refresh').onclick = fetchPending;
        document.getElementById('showAll').onclick = () => { fetch('/api/requests/all').then(r => r.json()).then(render) }
        function render(rows) {
            const el = document.getElementById('list'); el.innerHTML = '';
            if (rows.length === 0) el.innerHTML = '<i>No pending requests</i>';
            rows.forEach(r => {
                const d = document.createElement('div'); d.className = 'card';
                d.innerHTML = `<b>Request #${r.id}</b> â€” from ${r.caller_name || r.caller_id} (${r.caller_phone})<br><b>Question:</b> ${r.question}<br><div style="margin-top:8px"><textarea id="ans_${r.id}" placeholder="Type answer here..."></textarea><div style="margin-top:6px"><button onclick="answer(${r.id})">Submit Answer</button></div></div>`;
                el.appendChild(d);
            })
        }
        function renderKb(rows) {
            const el = document.getElementById('kb'); el.innerHTML = '';
            if (rows.length === 0) el.innerHTML = '<i>No learned answers yet</i>';
            rows.forEach(k => {
                const d = document.createElement('div'); d.className = 'card';
                d.innerHTML = `<b>Q:</b> ${k.question}<br><b>A:</b> ${k.answer}<br><small>${k.created_at}</small>`;
                el.appendChild(d);
            })
        }
        function answer(id) {
            const txt = document.getElementById('ans_' + id).value.trim();
            if (!txt) return alert('Please type an answer');
            fetch('/api/requests/' + id + '/answer', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer: txt, supervisor: 'Supervisor UI' }) }).then(r => r.json()).then(res => { alert('Answered'); fetchPending(); })
        }
        socket.on('new_request', (data) => { console.log('new_request', data); fetchPending(); alert('New help request: ' + data.text); });
        socket.on('request_resolved', (d) => { console.log('resolved', d); fetchPending(); fetch('/api/kb').then(r => r.json()).then(renderKb); });
        socket.on('request_timeout', (d) => { console.log('timeout', d); fetchPending(); });
        fetchPending();
    </script>
</body>

</html>